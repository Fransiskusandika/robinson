box: wercker/php
services:
  - wercker/mysql@0.0.8
build:
  steps:
    - script:
        name: install phalconphp
        code: |-
            git clone -q --depth=1 https://github.com/phalcon/cphalcon.git -b 1.2.5
            cd cphalcon/ext;
            export CFLAGS="-g3 -O1 -fno-delete-null-pointer-checks -Wall";
            phpize && ./configure --enable-phalcon && make -j4 && sudo make install
            echo 'extension=phalcon.so' >> $HOME/.phpenv/versions/$(phpenv version-name)/etc/php.ini
            phpenv rehash
    - script:
        name: install imagick
        code: |-
            echo '\n' | pecl install imagick
    - script:
        name: dependency install
        code: |-
            composer install --prefer-dist
    - script:
        name: replace config
        code: |-
            sed -e "s/{{DB_NAME}}/$WERCKER_MYSQL_DATABASE/" -e "s/{{DB_USER}}/$WERCKER_MYSQL_USERNAME/" -e "s/{{DB_PASSWORD}}/$WERCKER_MYSQL_PASSWORD/" -e "s/{{DB_HQL_HOST/" config/phinx-local.yml.dist
    - script:
        name: setup db
        code: |-
            cp config/phinx-local.yml.dist config/phinx-local.yml
            php vendor/bin/phinx migrate --configuration="config/phinx.yml" --environment="testing"